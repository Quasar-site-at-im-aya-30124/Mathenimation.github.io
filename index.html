<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths Equation Editor</title>

    <!-- MathJax -->
    <script>
        MathJax = {
            loader: { load: ['input/asciimath', 'output/chtml'] },
            asciimath: { 
                delimiters: [['`', '`']],
                symbols: {
                    '√': ['\u221A', 1],
                    'abs': ['|', 1],
                    'mod': ['\u0025', 1],
                    '≡': ['\u2261', 1],
                    'log': ['\u006C\u006F\u0067', 1],
                    'exp': ['\u0065\u005E', 1],
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" async></script>

    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body{font-family:Arial,sans-serif;padding:20px;background:#1c2526;color:#e0e0e0;}
        h1,p,li{color:#e0e0e0;}
        #header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
        #header-row h1{margin:0;}
        .menu-buttons{display:flex;gap:10px;}
        #header-row button{padding:8px 12px;font-size:16px;background:#4a4a4a;color:#e0e0e0;border:1px solid #666;cursor:pointer;}
        #header-row button:hover{background:#5a5a5a;}

        #input{width:100%;height:100px;font-size:18px;background:#2e2e2e;color:#e0e0e0;border:1px solid #4a4a4a;padding:10px;margin-top:10px;box-sizing:border-box;}
        #start-btn,#controls-row button,dialog button{margin:10px 5px;padding:10px;font-size:16px;background:#4a4a4a;color:#e0e0e0;border:1px solid #666;cursor:pointer;}
        #start-btn:hover,#controls-row button:hover,dialog button:hover{background:#5a5a5a;}

        #output{position:relative;min-height:200px;white-space:pre-wrap;overflow-wrap:break-word;max-width:100%;box-sizing:border-box;
                background:#013220;color:#000;border:1px solid #4a4a4a;padding:10px;margin:10px 0;overflow-x:auto;}
        #output mjx-container,#output mjx-container *{color:#000!important;fill:#000!important;}

        #hand{position:absolute;font-size:30px;transform:rotate(45deg);
              transition:left .1s ease,top .1s ease,transform .5s ease,opacity .5s ease .5s;
              animation:float 1.5s ease-in-out infinite;opacity:1;color:#e0e0e0;}
        @keyframes float{0%,100%{transform:translateY(0) rotate(45deg)}50%{transform:translateY(-5px) rotate(45deg)}}
        #output.finished #hand{animation:none;transform:rotate(120deg) translate(50px,50px);opacity:0;}

        #cursor{display:inline-block;width:2px;height:1.2em;background:#e0e0e0;vertical-align:middle;
                animation:blink 1s step-end infinite;}
        @keyframes blink{50%{opacity:0}}

        dialog{width:70vw;height:70vh;overflow:auto;padding:20px;box-sizing:border-box;
               background:#2e2e2e;color:#e0e0e0;border:1px solid #4a4a4a;}
        dialog button{position:absolute;top:10px;right:10px;}

        table{width:100%;border-collapse:collapse;}
        th,td{border:1px solid #4a4a4a;padding:8px;text-align:left;color:#e0e0e0;}
        th{background:#3a3a3a;}

        #controls-row{display:flex;justify-content:space-between;align-items:center;margin:10px 0;}
        #controls-row-left,#controls-row-right{display:flex;align-items:center;gap:5px;}
        #controls-row button,#controls-row select,#controls-row input[type=range]{
            margin-left:5px;background:#4a4a4a;color:#e0e0e0;border:1px solid #666;}
        #controls-row select{padding:8px;}
        #controls-row select option{background:#2e2e2e;color:#e0e0e0;}
        #speed-slider{width:100px;vertical-align:middle;}
        #controls{margin-top:10px;}

        #symbols-table td{text-align:center;cursor:pointer;padding:10px;}
        #symbols-table td:hover{background:#5a5a5a;}

        /* Progress bar */
        #progress-container{margin:10px 0;display:none;}
        #progress-bar{width:100%;height:12px;background:#333;border-radius:6px;overflow:hidden;}
        #progress-fill{width:0%;height:100%;background:#4caf50;transition:width .2s ease;}
        #progress-text{text-align:center;font-size:14px;margin-top:4px;}
    </style>
</head>
<body>
    <div id="header-row">
        <h1>Maths Equation Editor</h1>
        <div class="menu-buttons">
            <button onclick="showDialog('examples')">Examples</button>
            <button onclick="showDialog('history')">History</button>
            <button onclick="showDialog('help')">Help</button>
            <button onclick="showDialog('symbols')">Symbols</button>
        </div>
    </div>

    <div id="controls-row">
        <div id="controls-row-left">
            <button id="play-pause-btn" onclick="playPauseAnimation()">Play</button>
            <button onclick="stopAnimation()">Stop</button>
            <label for="speed-slider">Speed:</label>
            <input type="range" id="speed-slider" min="0.5" max="2" step="0.1" value="1">
        </div>
        <div id="controls-row-right">
            <button onclick="undo()">Undo</button>
            <button onclick="redo()">Redo</button>
            <button onclick="clearOutput()">Clear</button>
            <select id="download-format">
                <optgroup label="--Image--">
                    <option value="png">Save as PNG</option>
                    <option value="jpg">Save as JPG</option>
                    <option value="webp">Save as WebP</option>
                    <option value="bmp">Save as BMP</option>
                    <option value="tiff">Save as TIFF</option>
                    <option value="gif">Save as GIF</option>
                    <option value="avif">Save as AVIF</option>
                    <option value="apng">Save as APNG</option>
                </optgroup>
                <optgroup label="--Resolutions (Video)--">
                    <option value="426x240">240p (426x240)</option>
                    <option value="640x360">360p (640x360)</option>
                    <option value="854x480">480p (854x480)</option>
                    <option value="1280x720">720p (1280x720 - HD)</option>
                    <option value="1920x1080">1080p (1920x1080 - FHD)</option>
                    <option value="2560x1440">1440p (2560x1440 - 2K/QHD)</option>
                    <option value="3840x2160">2160p (3840x2160 - 4K/UHD)</option>
                </optgroup>
            </select>
            <button onclick="downloadOutput()">Download</button>
        </div>
    </div>

    <!-- Progress bar -->
    <div id="progress-container">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="progress-text">0 %</div>
    </div>

    <div id="output"></div>

    <div id="controls">
        <textarea id="input" placeholder="e.g., Modulus or Absolute Value Expression: |a| + |b| = |a + b|"></textarea>
        <div style="text-align: right; margin: 10px 0;">
            <button id="start-btn" onclick="startAnimation()">Start Animation</button>
        </div>
    </div>

    <canvas id="captureCanvas" style="display:none;"></canvas>

    <!-- DIALOGS (unchanged) -->
    <dialog id="examplesDialog">
        <h2>Examples</h2>
        <ul>
            <li>Monomial: 3x^2</li>
            <li>Binomial: x + 2y</li>
            <li>Trinomial: x^2 + 2x + 1</li>
            <li>Polynomial: x^3 + 2x^2 - x + 5</li>
            <li>Rational Expression: (x + 1)/(x - 2)</li>
            <li>Irrational Expression: √(x + 2)</li>
            <li>Radical Expression: root(3)(x^2 + 1)</li>
            <li>Square Root Expression: sqrt(x + 1) or √(x + 1)</li>
            <li>Exponential Expression: exp(x) or 2^x</li>
            <li>Logarithmic Expression: log(x) or log_2(x)</li>
            <li>Modulus (Absolute Value) Expression: |a| + |b| = |a + b|</li>
            <li>Modular Expression: x mod y = r ↔ x ≡ r (mod y)</li>
            <li>Fraction: a/b</li>
            <li>Integral: int_0^1 x dx</li>
            <li>Union: A union B</li>
            <li>Matrix: [1,2;3,4]</li>
            <li>Limit: lim_(x->0) sin x / x</li>
            <li>Derivative: (d/dx) x^2</li>
            <li>Sum: sum_(k=1)^n k</li>
            <li>Product: prod_(k=1)^n k</li>
            <li>Vector: vec(a) = <<1,2,3>></li>
            <li>Binomial Coefficient: C(n,k) or binom(n)(k)</li>
            <li>Trigonometric Expression: sin x + cos y</li>
            <li>Inverse Trigonometric: arcsin(x)</li>
            <li>Trigonometric Identity: sin^2 x + cos^2 x = 1</li>
            <li>Compound Angle: sin(a + b) = sin a cos b + cos a sin b</li>
            <li>Multiple Angle: cos 2x = cos^2 x - sin^2 x</li>
            <li>Differential Expression: (d/dx) sin x = cos x</li>
            <li>Integral Expression: int_0^infty e^{-x} dx = 1</li>
            <li>Limit Expression: lim_(x->0) (sin x)/x = 1</li>
            <li>Series Expression: sum_(n=1)^infty 1/n^2 = pi^2/6</li>
            <li>Mean: bar x = (sum x_i)/n</li>
            <li>Variance: sigma^2 = (sum (x_i - bar x)^2)/n</li>
            <li>Probability: P(A union B) = P(A) + P(B) - P(A intersect B)</li>
            <li>Combinations: C(n,r) = (n!)/(r!(n-r)!)</li>
            <li>Permutations: P(n,r) = (n!)/(n-r)!</li>
            <li>Vector Expression: r = a i^ + b j^ + c k^</li>
            <li>Dot Product: (vec A dot B)</li>
            <li>Cross Product: (vec A cross B)</li>
            <li>Matrix Expression: A = [1,2,3;4,5,6]</li>
            <li>Determinant: det(A) or (det(A))</li>
            <li>Inverse Matrix: A^(-1)</li>
            <li>Complex Number Expression: z = a + b i</li>
            <li>Set Expression: A = {1,2,3}</li>
            <li>Membership: (x in A) or (x belong to A)</li>
            <li>Logical Expression: p ^^ q</li>
            <li>Quantified Expression: (for all) x in R, x^2 (greater than or equal) 0</li>
            <li>Parametric Expression: x = r cos theta, y = r sin theta</li>
            <li>Polar Expression: r = theta</li>
            <li>Tensor Expression: T_(i j)</li>
            <li>Functional Analysis Expression: ||f|| = sqrt(int |f(x)|^2 dx)</li>
            <li>Topology Expression: open set U</li>
            <li>Algebraic Structure Expression: group G</li>
        </ul>
        <button onclick="closeDialog('examples')">Close</button>
    </dialog>

    <dialog id="historyDialog">
        <h2>History</h2>
        <table><thead><tr><th>Title</th><th>Description</th><th>Date</th><th>Time</th></tr></thead>
        <tbody id="historyBody"></tbody></table>
        <button onclick="closeDialog('history')">Close</button>
    </dialog>

    <dialog id="helpDialog">
        <h2>Help</h2>
        <p>… (all your original help text) …</p>
        <p><strong>Piecewise functions</strong>: <code>piecewise{x^2 if x<0; 2x if x>=0}</code></p>
        <button onclick="closeDialog('help')">Close</button>
    </dialog>

    <dialog id="symbolsDialog">
        <h2>Mathematical Symbols</h2>
        <p>Click a symbol to copy its AsciiMath code or character to the clipboard.</p>
        <table id="symbols-table">
            <tr><th>Symbol</th><th>AsciiMath Code</th><th>Description</th></tr>
            <!-- (your symbol rows unchanged) -->
        </table>
        <button onclick="closeDialog('symbols')">Close</button>
    </dialog>

    <script>
        /* ==== GLOBAL STATE ==== */
        let entries = [], currentOutput = '', undoStack = [], redoStack = [];
        let history = JSON.parse(localStorage.getItem('mathHistory')) || [];
        let isAnimating = false, isPaused = false, animationController = null;
        let recorder = null, recordedChunks = [];

        /* ==== MATH PROCESSING (unchanged) ==== */
        function processMathContent(str){/* unchanged */return str;}
        function detectMathExpressions(text){/* unchanged */return [];}

        /* ==== ANIMATION + PROGRESS ==== */
        async function startAnimation() {
            if (isAnimating) return;
            isAnimating = true; isPaused = false; animationController = { cancelled: false };
            const inputText = document.getElementById('input').value.trim();
            if (!inputText) { isAnimating = false; return; }

            const segments = detectMathExpressions(inputText);
            const output = document.getElementById('output');
            const startBtn = document.getElementById('start-btn');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const progCont = document.getElementById('progress-container');
            const progFill = document.getElementById('progress-fill');
            const progText = document.getElementById('progress-text');

            startBtn.disabled = true;
            playPauseBtn.textContent = 'Pause';
            output.classList.remove('finished');
            output.innerHTML = currentOutput;
            progCont.style.display = 'block';
            progFill.style.width = '0%';
            progText.textContent = '0 %';

            const hand = document.createElement('span');
            hand.id = 'hand'; hand.textContent = 'Write';
            hand.style.opacity = '1';

            let currentText = currentOutput ? currentOutput + '<br>' : '';
            const baseCharDelay = 50, baseWordDelay = 200;
            const speed = parseFloat(document.getElementById('speed-slider').value);
            const charDelay = baseCharDelay / speed;
            const wordDelay = baseWordDelay / speed;

            const totalChars = inputText.length;
            let renderedChars = currentOutput.replace(/<br>/g,'\n').length;

            // ---------- VIDEO RECORDING SETUP ----------
            const selected = document.getElementById('download-format').value;
            const isVideo = !!document.querySelector(`#download-format option[value="${selected}"]`).parentNode.label.includes('Video');
            if (isVideo) await startVideoRecording(output, selected);

            for (let seg of segments) {
                if (animationController.cancelled) break;
                const parts = seg.type === 'text' ? seg.content.split(/(\s+)/).filter(p=>p) :
                                                   seg.content.split(/(\s+)/).filter(p=>p);
                for (let part of parts) {
                    if (animationController.cancelled) break;
                    for (let ch of part) {
                        if (isPaused || animationController.cancelled){
                            while(isPaused && !animationController.cancelled) await delay(100);
                            if(animationController.cancelled) break;
                        }
                        currentText += ch; renderedChars++;
                        output.innerHTML = currentText + '<span id="cursor"></span>';
                        output.appendChild(hand);
                        await typesetMathJax();
                        updateHandPosition(hand);
                        await delay(charDelay);

                        const percent = Math.min(100, Math.round((renderedChars/totalChars)*100));
                        progFill.style.width = percent + '%';
                        progText.textContent = percent + ' %';
                    }
                    await delay(wordDelay);
                }
                // Math segment → wrap in backticks
                if (seg.type === 'math'){
                    const mathStart = currentText.length - seg.content.length;
                    const mathBuf = seg.content;
                    currentText = currentText.slice(0,mathStart) + '`' + mathBuf + '`' + currentText.slice(mathStart+mathBuf.length);
                    output.innerHTML = currentText + '<span id="cursor"></span>';
                    await typesetMathJax();
                    updateHandPosition(hand);
                    await delay(200);
                }
            }

            // ---------- FINALISE ----------
            if (!animationController.cancelled){
                output.innerHTML = currentText;
                await typesetMathJax();
                output.appendChild(hand);
                updateHandPosition(hand);
                output.classList.add('finished');
                await delay(1000);
                hand.remove();

                // store history
                entries.push(inputText);
                undoStack.push([...entries]);
                redoStack = [];
                history.push({title:`Input ${history.length+1}`,description:inputText,
                              date:new Date().toLocaleDateString(),
                              time:new Date().toLocaleTimeString()});
                localStorage.setItem('mathHistory', JSON.stringify(history));
                currentOutput = entries.join('<br>');

                // AUTO DOWNLOAD
                progFill.style.width = '100%';
                progText.textContent = '100 % – preparing download…';
                await delay(300);
                if (isVideo) await stopVideoRecording();
                else await downloadImage();
            }

            progCont.style.display = 'none';
            startBtn.disabled = false;
            playPauseBtn.textContent = 'Play';
            isAnimating = false;
            animationController = null;
        }

        /* ==== PLAY/PAUSE/STOP ==== */
        function playPauseAnimation(){
            if(!isAnimating) startAnimation();
            else{
                isPaused = !isPaused;
                document.getElementById('play-pause-btn').textContent = isPaused?'Play':'Pause';
            }
        }
        function stopAnimation(){
            if(!isAnimating) return;
            animationController.cancelled = true; isPaused = false; isAnimating = false;
            const out = document.getElementById('output');
            out.innerHTML = currentOutput; out.classList.remove('finished');
            const hand = document.querySelector('#hand'); if(hand) hand.remove();
            document.getElementById('start-btn').disabled = false;
            document.getElementById('play-pause-btn').textContent = 'Play';
            document.getElementById('progress-container').style.display = 'none';
            if(recorder) recorder.stop();
            typesetMathJax();
        }

        /* ==== UNDO/REDO/CLEAR ==== */
        function undo(){ if(undoStack.length){ redoStack.push([...entries]); entries=undoStack.pop(); currentOutput=entries.join('<br>'); renderOutput(); } }
        function redo(){ if(redoStack.length){ undoStack.push([...entries]); entries=redoStack.pop(); currentOutput=entries.join('<br>'); renderOutput(); } }
        function clearOutput(){ entries=[]; undoStack=[]; redoStack=[]; currentOutput=''; renderOutput(); }
        function renderOutput(){ document.getElementById('output').innerHTML = currentOutput; typesetMathJax(); }

        /* ==== IMAGE DOWNLOAD ==== */
        async function downloadImage(){
            const selected = document.getElementById('download-format').value;
            const output = document.getElementById('output');

            const mimeMap = {
                png:'image/png', jpg:'image/jpeg', webp:'image/webp',
                bmp:'image/bmp', tiff:'image/tiff', gif:'image/gif',
                avif:'image/avif', apng:'image/png'
            };
            const mime = mimeMap[selected] || 'image/png';
            const ext = selected;

            try{
                const canvas = await html2canvas(output,{scale:2});
                const dataURL = canvas.toDataURL(mime, selected==='jpg'?0.92:1);
                const a = document.createElement('a');
                a.href = dataURL; a.download = `math_output.${ext}`;
                a.click();
            }catch(e){ console.error(e); alert('Image download failed'); }
        }

        /* ==== VIDEO RECORDING ==== */
        async function startVideoRecording(element, resolution){
            const [w,h] = resolution.split('x').map(Number);
            const stream = element.captureStream ? element.captureStream(30) : await html2canvas(element,{scale:1}).then(c=>c.captureStream(30));
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');

            recordedChunks = [];
            recorder = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp9'});
            recorder.ondataavailable = e => recordedChunks.push(e.data);
            recorder.start();

            // draw each frame to the sized canvas
            const drawFrame = async () => {
                if(!recorder || recorder.state!=='recording') return;
                const srcCanvas = await html2canvas(element,{scale:1});
                const ratio = srcCanvas.width/srcCanvas.height;
                let drawW = w, drawH = h;
                if(w/h > ratio) drawW = h*ratio;
                else drawH = w/ratio;
                ctx.fillStyle = '#013220';
                ctx.fillRect(0,0,w,h);
                ctx.drawImage(srcCanvas,(w-drawW)/2,(h-drawH)/2,drawW,drawH);
                requestAnimationFrame(drawFrame);
            };
            drawFrame();
        }

        async function stopVideoRecording(){
            if(!recorder) return;
            recorder.stop();
            await new Promise(r=>recorder.onstop=r);
            const blob = new Blob(recordedChunks,{type:'video/webm'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const res = document.getElementById('download-format').value;
            a.download = `math_animation_${res}.webm`;
            a.click();
            URL.revokeObjectURL(url);
            recorder = null; recordedChunks = [];
        }

        /* ==== MANUAL DOWNLOAD BUTTON ==== */
        async function downloadOutput(){
            const selected = document.getElementById('download-format').value;
            const isVideo = !!document.querySelector(`#download-format option[value="${selected}"]`).parentNode.label.includes('Video');
            if(isVideo){
                // re-record a short video of the current static output
                const out = document.getElementById('output');
                await startVideoRecording(out, selected);
                setTimeout(()=>stopVideoRecording(),1500); // 1.5 s static video
            }else{
                await downloadImage();
            }
        }

        /* ==== DIALOG HELPERS ==== */
        function showDialog(id){
            const d=document.getElementById(id+'Dialog'); d.showModal();
            if(id==='history') populateHistory();
            else if(id==='symbols') setupSymbolTable();
        }
        function closeDialog(id){ document.getElementById(id+'Dialog').close(); }
        function populateHistory(){/* unchanged */ }
        function setupSymbolTable(){/* unchanged */ }
        function copyToClipboard(txt,type){/* unchanged */ }

        async function typesetMathJax(){ try{await MathJax.typesetPromise([document.getElementById('output')]);}catch(e){} }
        function updateHandPosition(hand){/* unchanged */ }
        function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
    </script>
</body>
</html>
