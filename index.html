<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathenimation: Math Equation Editors Tutors & Students</title>
    <!-- MathJax Configuration -->
    <script>
        MathJax = {
            loader: { load: ['input/asciimath', 'output/chtml'] },
            asciimath: { 
                delimiters: [['`', '`']],
                symbols: {
                    '√': ['\u221A', 1],
                    'abs': ['|', 1],
                    'mod': ['\u0025', 1],
                    '≡': ['\u2261', 1],
                    'log': ['\u006C\u006F\u0067', 1],
                    'exp': ['\u0065\u005E', 1],
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" async></script>
    <!-- html2canvas for download -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1c2526;
            color: #e0e0e0;
        }
        h1, p, li {
            color: #e0e0e0;
        }
        #header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #header-row h1 {
            margin: 0;
        }
        #header-row .menu-buttons {
            display: flex;
            gap: 10px;
        }
        #header-row button {
            padding: 8px 12px;
            font-size: 16px;
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: 1px solid #666;
            cursor: pointer;
        }
        #header-row button:hover {
            background-color: #5a5a5a;
        }
        #input {
            width: 100%;
            height: 100px;
            font-size: 18px;
            background-color: #2e2e2e;
            color: #e0e0e0;
            border: 1px solid #4a4a4a;
            padding: 10px;
            margin-top: 10px;
            box-sizing: border-box;
        }
        #start-btn, #controls-row button, dialog button {
            margin: 10px 5px;
            padding: 10px;
            font-size: 16px;
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: 1px solid #666;
            cursor: pointer;
        }
        #start-btn:hover, #controls-row button:hover, dialog button:hover {
            background-color: #5a5a5a;
        }
        #output {
            font-size: 24px;
            position: relative;
            min-height: 200px;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            max-width: 100%;
            box-sizing: border-box;
            background-color: lawngreen;
            color: black;
            border: 1px solid #4a4a4a;
            padding: 10px;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        #output mjx-container,
        #output mjx-container * {
            color: black !important;
            fill: black !important;
        }

        #hand {
            position: absolute;
            font-size: 30px;
            transform: rotate(45deg);
            transition: left 0.1s ease, top 0.1s ease, transform 0.5s ease, opacity 0.5s ease 0.5s;
            animation: float 1.5s ease-in-out infinite;
            opacity: 1;
            color: #e0e0e0;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(45deg); }
            50% { transform: translateY(-5px) rotate(45deg); }
        }
        #output.finished #hand {
            animation: none;
            transform: rotate(120deg) translate(50px, 50px);
            opacity: 0;
        }
        #cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #e0e0e0;
            vertical-align: middle;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        dialog {
            width: 70vw;
            height: 70vh;
            overflow: auto;
            padding: 20px;
            box-sizing: border-box;
            background-color: #2e2e2e;
            color: #e0e0e0;
            border: 1px solid #4a4a4a;
        }
        dialog button {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #4a4a4a;
            padding: 8px;
            text-align: left;
            color: #e0e0e0;
        }
        th {
            background-color: #3a3a3a;
        }
        #controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        #controls-row-left, #controls-row-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #controls-row button, #controls-row select, #controls-row input[type="range"] {
            margin-left: 5px;
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: 1px solid #666;
        }
        #controls-row select {
            padding: 8px;
        }
        #controls-row select option {
            background-color: #2e2e2e;
            color: #e0e0e0;
        }
        #speed-slider {
            width: 100px;
            vertical-align: middle;
        }
        #controls {
            margin-top: 10px;
        }
        #symbols-table td {
            text-align: center;
            cursor: pointer;
            padding: 10px;
        }
        #symbols-table td:hover {
            background-color: #5a5a5a;
        }

        /* Progress Bar */
        #progress-container {
            width: 100%;
            background-color: #333;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
            height: 20px;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
        #progress-text {
            text-align: center;
            font-size: 14px;
            margin-top: 5px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="header-row">
        <h1>Mathenimation</h1>
        <div class="menu-buttons">
            <button onclick="showDialog('examples')">Examples</button>
            <button onclick="showDialog('history')">History</button>
            <button onclick="showDialog('help')">Help</button>
            <button onclick="showDialog('symbols')">Symbols</button>
        </div>
    </div>

    <!-- Progress Bar -->
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
    <div id="progress-text">0% Complete</div>

    <div id="controls-row">
        <div id="controls-row-left">
            <button id="play-pause-btn" onclick="playPauseAnimation()">Play</button>
            <button onclick="stopAnimation()">Stop</button>
            <label for="speed-slider">Speed:</label>
            <input type="range" id="speed-slider" min="0.5" max="2" step="0.1" value="1">
        </div>
        <div id="controls-row-right">
            <button onclick="undo()">Undo</button>
            <button onclick="redo()">Redo</button>
            <button onclick="clearOutput()">Clear</button>
            <select id="download-format">
                <optgroup label="--Image--">
                    <option value="png">Save as PNG</option>
                    <option value="jpg">Save as JPG</option>
                    <option value="webp">Save as WebP</option>
                    <option value="bmp">Save as BMP</option>
                    <option value="tiff">Save as TIFF</option>
                    <option value="gif">Save as GIF</option>
                    <option value="avif">Save as AVIF</option>
                    <option value="apng">Save as APNG</option>
                </optgroup>
                <optgroup label="--Resolutions--">
                    <option value="426x240">240p (426x240)</option>
                    <option value="640x360">360p (640x360)</option>
                    <option value="854x480">480p (854x480)</option>
                    <option value="1280x720">720p (1280x720 - HD)</option>
                    <option value="1920x1080">1080p (1920x1080 - FHD)</option>
                    <option value="2560x1440">1440p (2560x1440 - 2K/QHD)</option>
                    <option value="3840x2160">2160p (3840x2160 - 4K/UHD)</option>
                </optgroup>
            </select>
            <button onclick="downloadOutput()">Download</button>
        </div>
    </div>

    <div id="output"></div>
    <div id="controls">
        <textarea id="input" placeholder="e.g., |a| + |b| = |a + b| or piecewise: f(x) = { x if x >= 0; -x if x < 0 }"></textarea>
        <div style="text-align: right; margin: 10px 0;">
            <button id="start-btn" onclick="startAnimation()">Start Animation</button>
        </div>
    </div>

    <canvas id="captureCanvas" style="display: none;"></canvas>

    <!-- Dialogs (unchanged) -->
    <dialog id="examplesDialog">
        <h2>Examples</h2>
        <ul>
            <li>Monomial: 3x^2</li>
            <li>Binomial: x + 2y</li>
            <li>Trinomial: x^2 + 2x + 1</li>
            <li>Polynomial: x^3 + 2x^2 - x + 5</li>
            <li>Rational Expression: (x + 1)/(x - 2)</li>
            <li>Irrational Expression: √(x + 2)</li>
            <li>Radical Expression: root(3)(x^2 + 1)</li>
            <li>Square Root Expression: sqrt(x + 1) or √(x + 1)</li>
            <li>Exponential Expression: exp(x) or 2^x</li>
            <li>Logarithmic Expression: log(x) or log_2(x)</li>
            <li>Modulus (Absolute Value) Expression: |a| + |b| = |a + b|</li>
            <li>Modular Expression: x mod y = r ↔ x ≡ r (mod y)</li>
            <li>Fraction: a/b</li>
            <li>Integral: int_0^1 x dx</li>
            <li>Union: A union B</li>
            <li>Matrix: [1,2;3,4]</li>
            <li>Limit: lim_(x->0) sin x / x</li>
            <li>Derivative: (d/dx) x^2</li>
            <li>Sum: sum_(k=1)^n k</li>
            <li>Product: prod_(k=1)^n k</li>
            <li>Vector: vec(a) = <<1,2,3>></li>
            <li>Binomial Coefficient: C(n,k) or binom(n)(k)</li>
            <li>Trigonometric Expression: sin x + cos y</li>
            <li>Inverse Trigonometric: arcsin(x)</li>
            <li>Trigonometric Identity: sin^2 x + cos^2 x = 1</li>
            <li>Compound Angle: sin(a + b) = sin a cos b + cos a sin b</li>
            <li>Multiple Angle: cos 2x = cos^2 x - sin^2 x</li>
            <li>Differential Expression: (d/dx) sin x = cos x</li>
            <li>Integral Expression: int_0^infty e^{-x} dx = 1</li>
            <li>Limit Expression: lim_(x->0) (sin x)/x = 1</li>
            <li>Series Expression: sum_(n=1)^infty 1/n^2 = pi^2/6</li>
            <li>Mean: bar x = (sum x_i)/n</li>
            <li>Variance: sigma^2 = (sum (x_i - bar x)^2)/n</li>
            <li>Probability: P(A union B) = P(A) + P(B) - P(A intersect B)</li>
            <li>Combinations: C(n,r) = (n!)/(r!(n-r)!)</li>
            <li>Permutations: P(n,r) = (n!)/(n-r)!</li>
            <li>Vector Expression: r = a i^ + b j^ + c k^</li>
            <li>Dot Product: (vec A dot B)</li>
            <li>Cross Product: (vec A cross B)</li>
            <li>Matrix Expression: A = [1,2,3;4,5,6]</li>
            <li>Determinant: det(A) or (det(A))</li>
            <li>Inverse Matrix: A^(-1)</li>
            <li>Complex Number Expression: z = a + b i</li>
            <li>Set Expression: A = {1,2,3}</li>
            <li>Membership: (x in A) or (x belong to A)</li>
            <li>Logical Expression: p ^^ q</li>
            <li>Quantified Expression: (for all) x in R, x^2 (greater than or equal) 0</li>
            <li>Parametric Expression: x = r cos theta, y = r sin theta</li>
            <li>Polar Expression: r = theta</li>
            <li>Tensor Expression: T_(i j)</li>
            <li>Functional Analysis Expression: ||f|| = sqrt(int |f(x)|^2 dx)</li>
            <li>Topology Expression: open set U</li>
            <li>Algebraic Structure Expression: group G</li>
            <li><strong>Piecewise: f(x) = { x if x >= 0; -x if x < 0 }</strong></li>
        </ul>
        <button onclick="closeDialog('examples')">Close</button>
    </dialog>

    <!-- Other dialogs (history, help, symbols) unchanged -->
    <dialog id="historyDialog">
        <h2>History</h2>
        <table>
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Date</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
        <button onclick="closeDialog('history')">Close</button>
    </dialog>

    <dialog id="helpDialog">
        <h2>Help</h2>
        <p>Here are some tips for using AsciiMath syntax to achieve textbook-style mathematical representations:</p>
        <ul>
            <li>For exponents/superscripts, use ^: e.g., x^2 renders as x².</li>
            <li>For subscripts, use _: e.g., x_1 renders as x₁.</li>
            <li>For fractions, use /: e.g., a/b or (x + 1)/(x - 2) renders as a over b.</li>
            <li>For square roots, use sqrt or √: e.g., sqrt(x + 1) or √(x + 1) renders as √(x + 1).</li>
            <li>For nth roots, use root(n): e.g., root(3)(x) renders as cube root of x.</li>
            <li>For logarithms, use log or log_b: e.g., log(x) or log_2(x).</li>
            <li>For exponentials, use exp or ^: e.g., exp(x) or 2^x.</li>
            <li>For modulus (absolute value), use abs or | |: e.g., abs(x) or |x| renders as |x|.</li>
            <li>For modular arithmetic, use mod or ≡: e.g., x mod y = r or x ≡ r (mod y).</li>
            <li>For integrals, use int: e.g., int_a^b f(x) dx.</li>
            <li>For limits, use lim: e.g., lim_(x->a) f(x).</li>
            <li>For sums/products, use sum/prod: e.g., sum_(i=1)^n i.</li>
            <li>For matrices, use [ ; ]: e.g., [1,2;3,4] renders as a 2x2 matrix.</li>
            <li>For trigonometric functions, use sin, cos, tan, etc.: e.g., sin x.</li>
            <li>For inverse trigonometric, use arcsin, arccos, etc.: e.g., arcsin x.</li>
            <li>For hyperbolic functions, use sinh, cosh, etc.: e.g., sinh x.</li>
            <li>For derivatives, use (d/dx): e.g., (d/dx) x^2 = 2x.</li>
            <li>For integrals, use int: e.g., int x dx = x^2/2.</li>
            <li>For limits, use lim: e.g., lim_(x->infty) 1/x = 0.</li>
            <li>For series/sums, use sum: e.g., sum_(n=0)^infty x^n / n! = e^x.</li>
            <li>For mean, use bar or overline: e.g., bar x.</li>
            <li>For variance, use sigma^2: e.g., sigma^2 = (sum (x_i - bar x)^2)/n.</li>
            <li>For probability, use P(): e.g., P(A).</li>
            <li>For combinations, use C(n,r): e.g., C(n,r) = n! / (r!(n-r)!).</li>
            <li>For permutations, use P(n,r): e.g., P(n,r) = n! / (n-r)!.</li>
            <li>For vectors, use vec: e.g., vec a = a i^ + b j^ + c k^ renders with hats on i, j, k.</li>
            <li>For dot product, use dot: e.g., (vec A dot B) renders as \vec A • \vec B.</li>
            <li>For cross product, use cross: e.g., (vec A cross B) renders as \vec A × \vec B.</li>
            <li>For determinant, use det: e.g., det(A) or (det(A)) for |A|.</li>
            <li>For inverse matrix, use ^(-1): e.g., A^(-1).</li>
            <li>For complex numbers, use i: e.g., z = a + b i.</li>
            <li>For sets, use {}, in, union, intersect: e.g., A union B.</li>
            <li>For membership, use in or belong to: e.g., (x in A) or (x belong to A) renders as x ∈ A; (x not in A) or (x does not belong to A) renders as x ∉ A. Without (), treated as text.</li>
            <li>For logical expressions, use ^^, vv, not, ->: e.g., p ^^ q.</li>
            <li>For quantified expressions, use for all: e.g., (for all) x in R renders as ∀x ∈ R. Without (), treated as text.</li>
            <li>For inequalities, use (greater than or equal), etc.: e.g., (greater than or equal) renders as ≥, (less than or equal) as ≤, (not equal) as ≠. Without (), treated as text.</li>
            <li>For parametric equations, group with commas: e.g., x = t^2, y = t^3.</li>
            <li>For polar coordinates, use r, theta: e.g., r = 1 - sin theta.</li>
            <li>For tensors, use subscripts: e.g., T_(i j k).</li>
            <li>For norms in functional analysis, use || ||: e.g., ||f||.</li>
            <li>For topology, describe in text with math: e.g., open set U.</li>
            <li>For algebraic structures, describe in text with math: e.g., group (G, *).</li>
            <li>Group with parentheses for complex expressions: e.g., (a + b)^2.</li>
            <li>Mix text and math: e.g., Modulus (Absolute Value) Expression: |a| + |b| = |a + b|.</li>
            <li>Math expressions are auto-detected; backticks are optional.</li>
            <li><strong>Piecewise: Use <code>{ a if cond; b if cond }</code> or <code>piecewise</code></strong></li>
        </ul>
        <button onclick="closeDialog('help')">Close</button>
    </dialog>

    <dialog id="symbolsDialog">
        <h2>Mathematical Symbols</h2>
        <p>Click a symbol to copy its AsciiMath code or character to the clipboard.</p>
        <table id="symbols-table">
            <tr><th>Symbol</th><th>AsciiMath Code</th><th>Description</th></tr>
            <tr><td>∈</td><td>in</td><td>Element of</td></tr>
            <tr><td>∀</td><td>forall</td><td>For all</td></tr>
            <tr><td>≥</td><td>>=</td><td>Greater than or equal to</td></tr>
            <tr><td>≤</td><td><=</td><td>Less than or equal to</td></tr>
            <tr><td>≠</td><td>!=</td><td>Not equal to</td></tr>
            <tr><td>∂</td><td>partial</td><td>Partial derivative</td></tr>
            <tr><td>∃</td><td>exists</td><td>There exists</td></tr>
            <tr><td>∇</td><td>grad</td><td>Gradient (nabla)</td></tr>
            <tr><td>∋</td><td>ni</td><td>Contains as member</td></tr>
            <tr><td>∏</td><td>prod</td><td>Product</td></tr>
            <tr><td>∙</td><td>cdot</td><td>Dot product</td></tr>
            <tr><td>∝</td><td>prop</td><td>Proportional to</td></tr>
            <tr><td>∞</td><td>infty</td><td>Infinity</td></tr>
            <tr><td>∪</td><td>union</td><td>Union</td></tr>
            <tr><td>∩</td><td>intersect</td><td>Intersection</td></tr>
            <tr><td>∨</td><td>vv</td><td>Logical OR</td></tr>
            <tr><td>∧</td><td>^^</td><td>Logical AND</td></tr>
            <tr><td>∠</td><td>angle</td><td>Angle</td></tr>
            <tr><td>∥</td><td>||</td><td>Parallel</td></tr>
            <tr><td>∫</td><td>int</td><td>Integral</td></tr>
            <tr><td>∬</td><td>iint</td><td>Double integral</td></tr>
            <tr><td>∮</td><td>oint</td><td>Contour integral</td></tr>
            <tr><td>∴</td><td>therefore</td><td>Therefore</td></tr>
            <tr><td>∵</td><td>because</td><td>Because</td></tr>
            <tr><td>≪</td><td><<</td><td>Much less than</td></tr>
            <tr><td>≫</td><td>>></td><td>Much greater than</td></tr>
            <tr><td>⊂</td><td>subset</td><td>Subset</td></tr>
            <tr><td>⊃</td><td>supset</td><td>Superset</td></tr>
            <tr><td>⊆</td><td>subseteq</td><td>Subset or equal to</td></tr>
            <tr><td>⊇</td><td>supseteq</td><td>Superset or equal to</td></tr>
            <tr><td>⊙</td><td>odot</td><td>Circle dot</td></tr>
            <tr><td>⊥</td><td>perp</td><td>Perpendicular</td></tr>
            <tr><td>¹</td><td>^1</td><td>Superscript 1</td></tr>
            <tr><td>²</td><td>^2</td><td>Superscript 2</td></tr>
            <tr><td>³</td><td>^3</td><td>Superscript 3</td></tr>
            <tr><td>⁴</td><td>^4</td><td>Superscript 4</td></tr>
            <tr><td>₁</td><td>_1</td><td>Subscript 1</td></tr>
            <tr><td>₂</td><td>_2</td><td>Subscript 2</td></tr>
            <tr><td>₃</td><td>_3</td><td>Subscript 3</td></tr>
            <tr><td>₄</td><td>_4</td><td>Subscript 4</td></tr>
            <tr><td>ⁿ</td><td>^n</td><td>Superscript n</td></tr>
            <tr><td>½</td><td>1/2</td><td>Fraction one-half</td></tr>
            <tr><td>⅓</td><td>1/3</td><td>Fraction one-third</td></tr>
            <tr><td>⅔</td><td>2/3</td><td>Fraction two-thirds</td></tr>
            <tr><td>¼</td><td>1/4</td><td>Fraction one-quarter</td></tr>
            <tr><td>¾</td><td>3/4</td><td>Fraction three-quarters</td></tr>
            <tr><td>⅜</td><td>3/8</td><td>Fraction three-eighths</td></tr>
            <tr><td>⅝</td><td>5/8</td><td>Fraction five-eighths</td></tr>
            <tr><td>⅞</td><td>7/8</td><td>Fraction seven-eighths</td></tr>
            <tr><td>±</td><td>+-</td><td>Plus-minus</td></tr>
            <tr><td>﹙</td><td>(</td><td>Left parenthesis</td></tr>
            <tr><td>﹛</td><td>{</td><td>Left brace</td></tr>
            <tr><td>﹜</td><td>}</td><td>Right brace</td></tr>
            <tr><td>﹞</td><td>)</td><td>Right parenthesis</td></tr>
            <tr><td>﹤</td><td><</td><td>Less than</td></tr>
            <tr><td>﹡</td><td>*</td><td>Asterisk (multiplication)</td></tr>
            <tr><td>﹢</td><td>+</td><td>Plus</td></tr>
            <tr><td>﹦</td><td>=</td><td>Equals</td></tr>
            <tr><td>﹠</td><td>&</td><td>Ampersand (logical AND)</td></tr>
            <tr><td>﹟</td><td>#</td><td>Number sign</td></tr>
        </table>
        <button onclick="closeDialog('symbols')">Close</button>
    </dialog>

    <script>
        let entries = [];
        let currentOutput = '';
        let undoStack = [];
        let redoStack = [];
        let history = JSON.parse(localStorage.getItem('mathHistory')) || [];
        let isAnimating = false;
        let isPaused = false;
        let animationController = null;
        let totalChars = 0;
        let renderedChars = 0;

        // Update progress
        function updateProgress() {
            const percent = totalChars > 0 ? Math.round((renderedChars / totalChars) * 100) : 0;
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-text').textContent = percent + '% Complete';
            if (percent === 100 && !isAnimating) {
                setTimeout(downloadOutput, 800); // Auto-download after 100%
            }
        }

        function processMathContent(str) {
            str = str.replace(/\[([^\[]*?)\]/g, function(match, p1) {
                return '[[' + p1.replace(/;\s*/g, '],[') + ']]';
            });
            str = str.replace(/C\(([\w+]+),\s*([\w+]+)\)/g, 'binom($1)($2)');
            str = str.replace(/P\(([\w+]+),\s*([\w+]+)\)/g, '^$1 P_$2');
            str = str.replace(/\(\s*det\((.+?)\)\s*\)/g, '|$1|');
            str = str.replace(/cross/g, 'xx');
            str = str.replace(/i\^/g, 'hat i');
            str = str.replace(/j\^/g, 'hat j');
            str = str.replace(/k\^/g, 'hat k');

            if (str.startsWith('(') && str.endsWith(')')) {
                let inner = str.slice(1, -1).trim();
                const exactReplacements = {
                    'greater than or equal': '>=',
                    'less than or equal': '<=',
                    'not equal': '!=',
                };
                if (exactReplacements[inner]) {
                    str = exactReplacements[inner];
                } else {
                    inner = inner.replace(/for all/g, 'forall');
                    inner = inner.replace(/belong to/g, 'in');
                    inner = inner.replace(/does not belong to/g, 'notin');
                    inner = inner.replace(/greater than or equal/g, '>=');
                    inner = inner.replace(/less than or equal/g, '<=');
                    inner = inner.replace(/not equal/g, '!=');
                    str = inner;
                }
            }

            // Support piecewise
            str = str.replace(/\{([^;]+);\s*([^}]+)\}/g, 'piecewise($1 if $2)');
            return str;
        }

        function detectMathExpressions(text) {
            const segments = [];
            let i = 0;
            const n = text.length;
            let current = '';
            let mode = 'text';
            let parenDepth = 0;
            let absDepth = 0;
            let bracketDepth = 0;

            const textPhrases = ['Modulus (Absolute Value) Expression', 'Absolute Value'];
            const isMathStart = (char, nextChar, text, index) => {
                for (let phrase of textPhrases) {
                    if (index <= text.length - phrase.length && text.slice(index, index + phrase.length).startsWith(phrase)) {
                        return false;
                    }
                }
                return /\d|[a-zA-Z]/.test(char) ||
                       (char === '√' && nextChar === '(') ||
                       (char === '(' && /[a-zA-Z0-9√|]/.test(nextChar)) ||
                       char === '|' || char === '≡' || (char === '[' && /\d/.test(nextChar));
            };

            while (i < n) {
                const char = text.charAt(i);
                const nextChar = i + 1 < n ? text.charAt(i + 1) : '';
                let matchedPhrase = null;
                for (let phrase of textPhrases) {
                    if (text.slice(i, i + phrase.length).startsWith(phrase)) {
                        matchedPhrase = phrase;
                        break;
                    }
                }

                if (matchedPhrase && mode === 'text') {
                    segments.push({type: 'text', content: matchedPhrase});
                    i += matchedPhrase.length;
                    continue;
                }

                if (mode === 'text') {
                    if (isMathStart(char, nextChar, text, i)) {
                        mode = 'math';
                        if (current) segments.push({type: 'text', content: current});
                        current = '';
                        if (char === '(') parenDepth++;
                        else if (char === '|') absDepth++;
                        else if (char === '[') bracketDepth++;
                        current += char;
                        i++;
                    } else {
                        current += char;
                        i++;
                    }
                } else {
                    current += char;
                    if (char === '(') parenDepth++;
                    else if (char === ')') parenDepth--;
                    else if (char === '|') absDepth += (absDepth > 0 ? -1 : 1);
                    else if (char === '[') bracketDepth++;
                    else if (char === ']') bracketDepth--;

                    i++;
                    if (parenDepth < 0 || absDepth < 0 || bracketDepth < 0) {
                        segments.push({type: 'text', content: current});
                        current = ''; mode = 'text'; parenDepth = absDepth = bracketDepth = 0;
                    } else if (!/[a-zA-Z0-9\^\_\+\-\*\/\=\.\|\(\)\[\]\{\}\√≡]/.test(char) && parenDepth === 0 && absDepth === 0 && bracketDepth === 0) {
                        if (current.trim().length > 1 && /[\^\_\|√≡\d]/.test(current)) {
                            current = processMathContent(current);
                            segments.push({type: 'math', content: current});
                        } else {
                            segments.push({type: 'text', content: current});
                        }
                        current = ''; mode = 'text';
                    }
                }
            }
            if (current) {
                if (mode === 'math' && /[\^\_\|√≡\d]/.test(current)) {
                    current = processMathContent(current);
                    segments.push({type: 'math', content: current});
                } else {
                    segments.push({type: 'text', content: current});
                }
            }
            return segments;
        }

        async function startAnimation() {
            if (isAnimating) return;
            isAnimating = true; isPaused = false;
            animationController = { cancelled: false };
            const inputText = document.getElementById('input').value.trim();
            if (!inputText) { isAnimating = false; return; }

            const output = document.getElementById('output');
            const startBtn = document.getElementById('start-btn');
            const playPauseBtn = document.getElementById('play-pause-btn');
            startBtn.disabled = true;
            playPauseBtn.textContent = 'Pause';
            output.classList.remove('finished');

            output.innerHTML = currentOutput;
            const hand = document.createElement('span');
            hand.id = 'hand'; hand.textContent = 'Writing Hand';
            hand.style.opacity = '1';

            let currentText = currentOutput ? currentOutput + '<br>' : '';
            const segments = detectMathExpressions(inputText);
            totalChars = inputText.length;
            renderedChars = 0;

            const speed = parseFloat(document.getElementById('speed-slider').value);
            const charDelay = 50 / speed;
            const wordDelay = 200 / speed;

            for (let segment of segments) {
                if (animationController.cancelled) break;
                const parts = segment.content.split(/(\s+)/).filter(p => p);
                for (let part of parts) {
                    if (animationController.cancelled) break;
                    for (let char of part) {
                        if (isPaused || animationController.cancelled) {
                            while (isPaused && !animationController.cancelled) await delay(100);
                            if (animationController.cancelled) break;
                        }
                        currentText += char;
                        renderedChars++;
                        updateProgress();
                        output.innerHTML = currentText + '<span id="cursor"></span>';
                        output.appendChild(hand);
                        await typesetMathJax();
                        updateHandPosition(hand);
                        await delay(charDelay);
                    }
                    await delay(wordDelay);
                }

                if (segment.type === 'math') {
                    const mathStart = currentText.length - segment.content.length;
                    currentText = currentText.slice(0, mathStart) + '`' + segment.content + '`';
                    output.innerHTML = currentText + '<span id="cursor"></span>';
                    await typesetMathJax();
                    updateHandPosition(hand);
                    await delay(200);
                }
            }

            if (!animationController.cancelled) {
                output.innerHTML = currentText;
                await typesetMathJax();
                output.appendChild(hand);
                updateHandPosition(hand);
                output.classList.add('finished');
                await delay(1000);
                hand.remove();

                entries.push(inputText);
                undoStack.push([...entries]);
                redoStack = [];
                history.push({ title: `Input ${history.length + 1}`, description: inputText, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString() });
                localStorage.setItem('mathHistory', JSON.stringify(history));
                currentOutput = entries.join('<br>');
            }

            startBtn.disabled = false;
            playPauseBtn.textContent = 'Play';
            isAnimating = false;
            animationController = null;
            updateProgress();
        }

        function playPauseAnimation() {
            if (!isAnimating) startAnimation();
            else {
                isPaused = !isPaused;
                document.getElementById('play-pause-btn').textContent = isPaused ? 'Play' : 'Pause';
            }
        }

        function stopAnimation() {
            if (!isAnimating) return;
            animationController.cancelled = true;
            isPaused = false; isAnimating = false;
            document.getElementById('output').innerHTML = currentOutput;
            document.getElementById('output').classList.remove('finished');
            const hand = document.querySelector('#hand');
            if (hand) hand.remove();
            document.getElementById('start-btn').disabled = false;
            document.getElementById('play-pause-btn').textContent = 'Play';
            renderedChars = 0;
            updateProgress();
            typesetMathJax();
        }

        async function downloadOutput() {
            const selected = document.getElementById('download-format').value;
            const output = document.getElementById('output');
            const resolutions = {
                '426x240': { w: 426, h: 240 },
                '640x360': { w: 640, h: 360 },
                '854x480': { w: 854, h: 480 },
                '1280x720': { w: 1280, h: 720 },
                '1920x1080': { w: 1920, h: 1080 },
                '2560x1440': { w: 2560, h: 1440 },
                '3840x2160': { w: 3840, h: 2160 }
            };

            let format = selected;
            let ext = selected;
            let targetW = output.offsetWidth;
            let targetH = output.offsetHeight;

            if (resolutions[selected]) {
                targetW = resolutions[selected].w;
                targetH = resolutions[selected].h;
                format = 'png';
                ext = 'png';
            }

            const mime = {
                png: 'image/png',
                jpg: 'image/jpeg',
                webp: 'image/webp',
                gif: 'image/gif',
                avif: 'image/avif',
                apng: 'image/png'
            };

            try {
                const canvas = await html2canvas(output, { scale: 2, backgroundColor: '#90EE90' });
                const resized = document.createElement('canvas');
                resized.width = targetW; resized.height = targetH;
                const ctx = resized.getContext('2d');
                const ratio = canvas.width / canvas.height;
                let drawW = targetW, drawH = targetH;
                if (targetW / targetH > ratio) drawW = targetH * ratio;
                else drawH = targetW / ratio;
                const offsetX = (targetW - drawW) / 2;
                const offsetY = (targetH - drawH) / 2;
                ctx.fillStyle = '#90EE90';
                ctx.fillRect(0, 0, targetW, targetH);
                ctx.drawImage(canvas, offsetX, offsetY, drawW, drawH);

                const dataUrl = resized.toDataURL(mime[format] || 'image/png', format === 'jpg' ? 0.92 : 1.0);
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `math_equation_${new Date().getTime()}.${ext}`;
                a.click();
            } catch (err) {
                alert('Download failed: ' + err.message);
            }
        }

        // Other functions (undo, redo, dialogs, etc.) unchanged...
        function undo() { /* unchanged */ }
        function redo() { /* unchanged */ }
        function clearOutput() { entries = []; undoStack = []; redoStack = []; currentOutput = ''; document.getElementById('output').innerHTML = ''; updateProgress(); }
        function showDialog(id) { document.getElementById(id + 'Dialog').showModal(); if (id === 'history') populateHistory(); else if (id === 'symbols') setupSymbolTable(); }
        function closeDialog(id) { document.getElementById(id + 'Dialog').close(); }
        function populateHistory() { /* unchanged */ }
        function setupSymbolTable() { /* unchanged */ }
        function copyToClipboard(text, type) { navigator.clipboard.writeText(text).then(() => alert(`${type} copied!`)); }
        async function typesetMathJax() { try { await MathJax.typesetPromise([document.getElementById('output')]); } catch(e) {} }
        function updateHandPosition(hand) {
            const cursor = document.getElementById('cursor') || document.getElementById('output').lastChild;
            if (!cursor) return;
            const rect = cursor.getBoundingClientRect();
            const outRect = document.getElementById('output').getBoundingClientRect();
            hand.style.left = (rect.right - outRect.left + 10) + 'px';
            hand.style.top = (rect.top - outRect.top - 5) + 'px';
        }
        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

        // Initialize
        window.onload = () => {
            document.getElementById('input').value = 'f(x) = { x if x >= 0; -x if x < 0 }';
            updateProgress();
        };
    </script>
</body>
</html>
