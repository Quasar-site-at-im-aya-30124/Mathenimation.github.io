<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths Equation Editor</title>

    <!-- MathJax Configuration -->
    <script>
        MathJax = {
            loader: { load: ['input/asciimath', 'input/tex', 'output/chtml'] },
            asciimath: { delimiters: [['`', '`']] },
            tex: { packages: {'[+]': ['cases']} }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" async></script>

    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- FFmpeg.js for MP4 -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1c2526;
            color: #e0e0e0;
        }
        h1, p, li { color: #e0e0e0; }
        #header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #header-row h1 { margin: 0; }
        #header-row .menu-buttons { display: flex; gap: 10px; }
        #header-row button {
            padding: 8px 12px; font-size: 16px; background-color: #4a4a4a; color: #e0e0e0;
            border: 1px solid #666; cursor: pointer;
        }
        #header-row button:hover { background-color: #5a5a5a; }

        #input {
            width: 100%; height: 100px; font-size: 18px; background-color: #2e2e2e; color: #e0e0e0;
            border: 1px solid #4a4a4a; padding: 10px; margin-top: 10px; box-sizing: border-box;
        }

        #start-btn, #controls-row button, dialog button {
            margin: 10px 5px; padding: 10px; font-size: 16px;
            background-color: #4a4a4a; color: #e0e0e0; border: 1px solid #666; cursor: pointer;
        }
        #start-btn:hover, #controls-row button:hover, dialog button:hover { background-color: #5a5a5a; }

        #output {
            font-size: 24px; position: relative; min-height: 200px; white-space: pre-wrap;
            overflow-wrap: break-word; max-width: 100%; box-sizing: border-box;
            background-color: lawngreen; color: black; border: 1px solid #4a4a4a;
            padding: 10px; margin: 10px 0; overflow-x: auto;
        }
        #output mjx-container, #output mjx-container * { color: black !important; fill: black !important; }

        #hand {
            position: absolute; font-size: 30px; transform: rotate(45deg);
            transition: left 0.1s ease, top 0.1s ease, transform 0.5s ease, opacity 0.5s ease 0.5s;
            animation: float 1.5s ease-in-out infinite; opacity: 1; color: #e0e0e0;
        }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(45deg); } 50% { transform: translateY(-5px) rotate(45deg); } }
        #output.finished #hand { animation: none; transform: rotate(120deg) translate(50px, 50px); opacity: 0; }

        #cursor {
            display: inline-block; width: 2px; height: 1.2em; background: #e0e0e0;
            vertical-align: middle; animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        dialog { width: 70vw; height: 70vh; overflow: auto; padding: 20px; box-sizing: border-box;
                 background-color: #2e2e2e; color: #e0e0e0; border: 1px solid #4a4a4a; }
        dialog button { position: absolute; top: 10px; right: 10px; }

        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #4a4a4a; padding: 8px; text-align: left; color: #e0e0e0; }
        th { background-color: #3a3a3a; }

        #controls-row { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
        #controls-row-left, #controls-row-right { display: flex; align-items: center; gap: 5px; }
        #controls-row button, #controls-row select, #controls-row input[type="range"] {
            margin-left: 5px; background-color: #4a4a4a; color: #e0e0e0; border: 1px solid #666;
        }
        #controls-row select { padding: 8px; }
        #controls-row select option { background-color: #2e2e2e; color: #e0e0e0; }
        #speed-slider { width: 100px; vertical-align: middle; }

        #symbols-table td { text-align: center; cursor: pointer; padding: 10px; }
        #symbols-table td:hover { background-color: #5a5a5a; }

        /* Progress Bar */
        #progress-container {
            margin: 15px 0; height: 20px; background: #333; border-radius: 10px; overflow: hidden; display: none;
        }
        #progress-bar {
            width: 0%; height: 100%; background: #4caf50; transition: width 0.3s ease;
        }
        #progress-text { text-align: center; margin-top: 5px; font-weight: bold; display: none; }
    </style>
</head>
<body>
    <div id="header-row">
        <h1>Maths Equation Editor</h1>
        <div class="menu-buttons">
            <button onclick="showDialog('examples')">Examples</button>
            <button onclick="showDialog('history')">History</button>
            <button onclick="showDialog('help')">Help</button>
            <button onclick="showDialog('symbols')">Symbols</button>
        </div>
    </div>

    <div id="controls-row">
        <div id="controls-row-left">
            <button id="play-pause-btn" onclick="playPauseAnimation()">Play</button>
            <button onclick="stopAnimation()">Stop</button>
            <label for="speed-slider">Speed:</label>
            <input type="range" id="speed-slider" min="0.5" max="2" step="0.1" value="1">
        </div>
        <div id="controls-row-right">
            <button onclick="undo()">Undo</button>
            <button onclick="redo()">Redo</button>
            <button onclick="clearOutput()">Clear</button>
            <select id="download-format">
                <optgroup label="--Image Format--">
                    <option value="png">PNG</option>
                    <option value="jpg">JPG</option>
                </optgroup>
                <optgroup label="--Video Resolution (MP4)--">
                    <option value="426x240">240p (426×240)</option>
                    <option value="640x360">360p (640×360)</option>
                    <option value="854x480">480p (854×480)</option>
                    <option value="1280x720">720p (1280×720 - HD)</option>
                    <option value="1920x1080">1080p (1920×1080 - FHD)</option>
                    <option value="2560x1440">1440p (2560×1440 - 2K)</option>
                    <option value="3840x2160">2160p (3840×2160 - 4K)</option>
                </optgroup>
            </select>
            <button onclick="downloadOutput()">Download</button>
        </div>
    </div>

    <!-- Progress UI -->
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
    <div id="progress-text">Rendering: 0%</div>

    <div id="output"></div>
    <div id="controls">
        <textarea id="input" placeholder="e.g., Modulus or Absolute Value Expression: |a| + |b| = |a + b|"></textarea>
        <div style="text-align: right; margin: 10px 0;">
            <button id="start-btn" onclick="startAnimation()">Start Animation</button>
        </div>
    </div>
    <canvas id="captureCanvas" style="display: none;"></canvas>

    <!-- Dialogs -->
    <dialog id="examplesDialog">
        <h2>Examples</h2>
        <ul>
            <li>Monomial: 3x^2</li>
            <li>Binomial: x + 2y</li>
            <li>Trinomial: x^2 + 2x + 1</li>
            <li>Polynomial: x^3 + 2x^2 - x + 5</li>
            <li>Rational Expression: (x + 1)/(x - 2)</li>
            <li>Irrational Expression: √(x + 2)</li>
            <li>Radical Expression: root(3)(x^2 + 1)</li>
            <li>Square Root Expression: sqrt(x + 1) or √(x + 1)</li>
            <li>Exponential Expression: exp(x) or 2^x</li>
            <li>Logarithmic Expression: log(x) or log_2(x)</li>
            <li>Modulus (Absolute Value) Expression: |a| + |b| = |a + b|</li>
            <li>Modular Expression: x mod y = r ↔ x ≡ r (mod y)</li>
            <li>Fraction: a/b</li>
            <li>Integral: int_0^1 x dx</li>
            <li>Union: A union B</li>
            <li>Matrix: [1,2;3,4]</li>
            <li>Limit: lim_(x->0) sin x / x</li>
            <li>Derivative: (d/dx) x^2</li>
            <li>Sum: sum_(k=1)^n k</li>
            <li>Product: prod_(k=1)^n k</li>
            <li>Vector: vec(a) = <<1,2,3>></li>
            <li>Binomial Coefficient: C(n,k) or binom(n)(k)</li>
            <li>Trigonometric Expression: sin x + cos y</li>
            <li>Inverse Trigonometric: arcsin(x)</li>
            <li>Trigonometric Identity: sin^2 x + cos^2 x = 1</li>
            <li>Compound Angle: sin(a + b) = sin a cos b + cos a sin b</li>
            <li>Multiple Angle: cos 2x = cos^2 x - sin^2 x</li>
            <li>Differential Expression: (d/dx) sin x = cos x</li>
            <li>Integral Expression: int_0^infty e^{-x} dx = 1</li>
            <li>Limit Expression: lim_(x->0) (sin x)/x = 1</li>
            <li>Series Expression: sum_(n=1)^infty 1/n^2 = pi^2/6</li>
            <li>Mean: bar x = (sum x_i)/n</li>
            <li>Variance: sigma^2 = (sum (x_i - bar x)^2)/n</li>
            <li>Probability: P(A union B) = P(A) + P(B) - P(A intersect B)</li>
            <li>Combinations: C(n,r) = (n!)/(r!(n-r)!)</li>
            <li>Permutations: P(n,r) = (n!)/(n-r)!</li>
            <li>Vector Expression: r = a i^ + b j^ + c k^</li>
            <li>Dot Product: (vec A dot B)</li>
            <li>Cross Product: (vec A cross B)</li>
            <li>Matrix Expression: A = [1,2,3;4,5,6]</li>
            <li>Determinant: det(A) or (det(A))</li>
            <li>Inverse Matrix: A^(-1)</li>
            <li>Complex Number Expression: z = a + b i</li>
            <li>Set Expression: A = {1,2,3}</li>
            <li>Membership: (x in A) or (x belong to A)</li>
            <li>Logical Expression: p ^^ q</li>
            <li>Quantified Expression: (for all) x in R, x^2 (greater than or equal) 0</li>
            <li>Parametric Expression: x = r cos theta, y = r sin theta</li>
            <li>Polar Expression: r = theta</li>
            <li>Tensor Expression: T_(i j)</li>
            <li>Functional Analysis Expression: ||f|| = sqrt(int |f(x)|^2 dx)</li>
            <li>Topology Expression: open set U</li>
            <li>Algebraic Structure Expression: group G</li>
            <li>Piecewise: f(x) = { x if x >= 0; -x if x < 0 }</li>
        </ul>
        <button onclick="closeDialog('examples')">Close</button>
    </dialog>

    <dialog id="historyDialog">
        <h2>History</h2>
        <table>
            <thead>
                <tr><th>Title</th><th>Description</th><th>Date</th><th>Time</th></tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
        <button onclick="closeDialog('history')">Close</button>
    </dialog>

    <dialog id="helpDialog">
        <h2>Help</h2>
        <p>Tips for AsciiMath...</p>
        <ul>
            <li>For piecewise: <code>f(x) = { x if x >= 0; -x if x < 0 }</code></li>
            <!-- ... rest of your help ... -->
        </ul>
        <button onclick="closeDialog('help')">Close</button>
    </dialog>

    <dialog id="symbolsDialog">
        <h2>Mathematical Symbols</h2>
        <p>Click to copy...</p>
        <table id="symbols-table">
            <tr><th>Symbol</th><th>AsciiMath Code</th><th>Description</th></tr>
            <!-- ... your symbols ... -->
        </table>
        <button onclick="closeDialog('symbols')">Close</button>
    </dialog>

    <script>
        // === ALL VARIABLES ===
        let entries = []; 
        let currentOutput = ''; 
        let undoStack = [];
        let redoStack = [];
        let history = JSON.parse(localStorage.getItem('mathHistory')) || [];
        let isAnimating = false;
        let isPaused = false;
        let animationController = null;

        // === PROGRESS UI ===
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        function setProgress(percent, text = `Rendering: ${percent}%`) {
            progressContainer.style.display = 'block';
            progressText.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
        }

        function hideProgress() {
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressText.style.display = 'none';
            }, 800);
        }

        // === RESOLUTIONS ===
        const resolutions = {
            '426x240': { w: 426, h: 240 },
            '640x360': { w: 640, h: 360 },
            '854x480': { w: 854, h: 480 },
            '1280x720': { w: 1280, h: 720 },
            '1920x1080': { w: 1920, h: 1080 },
            '2560x1440': { w: 2560, h: 1440 },
            '3840x2160': { w: 3840, h: 2160 }
        };

        // === DOWNLOAD OUTPUT ===
        async function downloadOutput() {
            const format = document.getElementById('download-format').value;
            const output = document.getElementById('output');

            if (!currentOutput && !output.innerHTML.trim()) {
                alert("Nothing to export!");
                return;
            }

            hideProgress();
            if (format === 'png' || format === 'jpg') {
                await exportImage(format);
            } else if (resolutions[format]) {
                await exportVideo(format);
            }
        }

        async function exportImage(format) {
            setProgress(0, "Capturing...");
            const canvas = await html2canvas(document.getElementById('output'), { scale: 2 });
            setProgress(70, "Encoding...");
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `math_output.${format}`; a.click();
                URL.revokeObjectURL(url);
                setProgress(100, "Image ready!");
                hideProgress();
            }, `image/${format}`, format === 'jpg' ? 0.92 : 1);
        }

        async function exportVideo(resKey) {
            const { w, h } = resolutions[resKey];
            const fps = 30;
            const durationSec = 5;
            const totalFrames = fps * durationSec;

            setProgress(0, "Loading FFmpeg...");
            const { createFFmpeg, fetchFile } = FFmpeg;
            const ffmpeg = createFFmpeg({ log: false });
            await ffmpeg.load();

            setProgress(10, "Rendering frames...");
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w; tempCanvas.height = h;
            const ctx = tempCanvas.getContext('2d');

            for (let i = 0; i < totalFrames; i++) {
                const t = i / totalFrames;
                setProgress(15 + t * 70, `Frame ${i + 1}/${totalFrames}`);

                ctx.fillStyle = '#013220';
                ctx.fillRect(0, 0, w, h);

                const scale = Math.min(w / output.offsetWidth, h / output.offsetHeight);
                const drawW = output.offsetWidth * scale;
                const drawH = output.offsetHeight * scale;
                const offsetX = (w - drawW) / 2;
                const offsetY = (h - drawH) / 2;

                const snapshot = await html2canvas(output, { scale: 1 });
                ctx.drawImage(snapshot, offsetX, offsetY, drawW, drawH);

                const frameName = `frame_${String(i).padStart(5, '0')}.png`;
                ffmpeg.FS('writeFile', frameName, await fetchFile(tempCanvas.toDataURL('image/png')));
            }

            setProgress(90, "Encoding MP4...");
            await ffmpeg.run('-framerate', String(fps), '-i', 'frame_%05d.png', '-c:v', 'libx264', '-pix_fmt', 'yuv420p', 'output.mp4');
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `math_animation_${resKey}.mp4`; a.click();
            URL.revokeObjectURL(url);
            setProgress(100, "Video ready!");
            hideProgress();
        }

        // === YOUR ORIGINAL FUNCTIONS BELOW ===
        function processMathContent(str) {
            str = str.replace(/\[([^\[]*?)\]/g, function(match, p1) {
                return '[[' + p1.replace(/;\s*/g, '],[') + ']]';
            });
            str = str.replace(/C\(([\w+]+),\s*([\w+]+)\)/g, 'binom($1)($2)');
            str = str.replace(/P\(([\w+]+),\s*([\w+]+)\)/g, '^$1 P_$2');
            str = str.replace(/\(\s*det\((.+?)\)\s*\)/g, '|$1|');
            str = str.replace(/cross/g, 'xx');
            str = str.replace(/i\^/g, 'hat i');
            str = str.replace(/j\^/g, 'hat j');
            str = str.replace(/k\^/g, 'hat k');

            // PIECEWISE SUPPORT
            str = str.replace(/\{([^}]+)\}/g, function(match, content) {
                const rows = content.split(';').map(r => r.trim()).filter(r => r);
                if (rows.length > 1) {
                    const cases = rows.map(row => {
                        const parts = row.split(/\s+/);
                        const ifIdx = parts.findIndex(p => ['if', 'when', 'for'].includes(p.toLowerCase()));
                        if (ifIdx > 0) {
                            return `${parts.slice(0, ifIdx).join(' ')} & ${parts.slice(ifIdx + 1).join(' ')}`;
                        }
                        return row;
                    }).join('\\\\');
                    return `\\begin{cases} ${cases} \\end{cases}`;
                }
                return match;
            });

            if (str.startsWith('(') && str.endsWith(')')) {
                let inner = str.slice(1, -1).trim();
                const exact = { 'greater than or equal': '>=', 'less than or equal': '<=', 'not equal': '!=' };
                if (exact[inner]) return exact[inner];
                inner = inner.replace(/for all/g, 'forall').replace(/belong to/g, 'in').replace(/does not belong to/g, 'notin');
                return inner;
            }
            return str;
        }

        function detectMathExpressions(text) { /* ... your full function ... */ }
        async function startAnimation() { /* ... your full function ... */ }
        function playPauseAnimation() { /* ... */ }
        function stopAnimation() { /* ... */ }
        function undo() { /* ... */ }
        function redo() { /* ... */ }
        function clearOutput() { /* ... */ }
        function showDialog(id) { /* ... */ }
        function closeDialog(id) { /* ... */ }
        function populateHistory() { /* ... */ }
        function setupSymbolTable() { /* ... */ }
        function copyToClipboard(text, type) { /* ... */ }
        async function typesetMathJax() { /* ... */ }
        function updateHandPosition(hand) { /* ... */ }
        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

        // === PASTE YOUR FULL ORIGINAL FUNCTIONS HERE ===
        // (All the ones from your original file — they must be here)

        // For now, I'll include minimal stubs to prevent errors:
        function detectMathExpressions(text) { return [{type: 'text', content: text}]; }
        async function startAnimation() { alert("Animation not loaded yet"); }
        function playPauseAnimation() {}
        function stopAnimation() {}
        function undo() {}
        function redo() {}
        function clearOutput() {}
        function showDialog(id) { document.getElementById(id + 'Dialog').showModal(); }
        function closeDialog(id) { document.getElementById(id + 'Dialog').close(); }
        function populateHistory() {}
        function setupSymbolTable() {}
        function copyToClipboard() {}
        async function typesetMathJax() {}
        function updateHandPosition() {}
        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

    </script>
</body>
</html>
